<html>
  <head>
    <title>Visualizing death registration and birth registration</title>
    <link type="text/css" rel="stylesheet" href="libs/ex.css"/>
	<link type="text/css" href="css/custom-theme/jquery-ui-1.8.11.custom.css" rel="stylesheet" />	
	<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui-1.8.11.custom.min.js"></script>
    <script type="text/javascript" src="libs/protovis-r3.2.js"></script>
    <script type="text/javascript" src="libs/centroid.js"></script>
    <script type="text/javascript" src="us_lowres.js"></script>
    <script type="text/javascript" src="birthreg_grid_simple.js"></script>

    <style type="text/css">

#fig {
  width: 900px;
  height: 460px;
}

#container {
  height: 10px;
}

#yearSlider {
  position: absolute;
  left: 100;
  right: 90;
  margin-top: 0;
}

#yearLabel {
  position: absolute;
  left: 0;
  width: 85;
  text-align: right;
}

#play {
  position: absolute;
  right: 50px;
  cursor: pointer;
}

    </style>
  </head>
  <body><div id="center"><h2>US Death & Birth Registration Areas, 1903-1933</h2><div id="fig">
    <script type="text/javascript+protovis">

$(yearSlider).slider({
  min: birthreg.minYear,
  max: birthreg.maxYear,
  value: birthreg.startYear,  
  slide: function(e, ui) {
    year = ui.value;
    vis.render();
  }
});
 
var year = birthreg.minYear;

var w = 890,
    h = 500,
    yearsMargin = 100;

var scale = pv.Geo.scale()
    .domain({lng: -128, lat: 24}, {lng: -64, lat: 50})
    .range({x: 0, y: 0}, {x: w, y: h});

var yearsScale = pv.Scale.linear()
    .domain(birthreg.minYear, birthreg.maxYear)
    .range(yearsMargin + 2, w - yearsMargin);

// TO DO: clean this mess up with some bitwise logic.
var labels = ["neither DRA nor BRA", "DRA", "DRA and BRA"];
var colors = pv.colors("#CCCCCC","#9999cc","#666699");

var col = function(y, d) {
  var inBRA = (y >= d.year_entered_birth_reg_area);
  var inDRA = (y >= d.year_entered_death_reg_area);
  if (!inBRA && !inDRA) return "#CCCCCC";
  if (!inBRA && inDRA) return "#9999cc";
  if (inBRA && inDRA) return "#666699";
  return "#000000";
};

// Find the centroid for each state
us_lowres.forEach(function(c) {
  c.code = c.code.toUpperCase();
  c.centLatLon = centroid(c.borders[0]);
});

var timer = undefined;
function playClick() {
  if (timer) {
    stop();
  } else {
    if (year == birthreg.maxYear) year = birthreg.minYear;
    $(yearSlider).slider('value', year);
    $(play).attr("src", 'stop.png');
    vis.render();
    timer = setInterval(function() {
      year++;
      if (year >= birthreg.maxYear) stop();
      $(yearSlider).slider('value', year);
      vis.render();
    }, 900);
  }
}

// Stop the animation
function stop() {
  clearInterval(timer);
  timer = undefined;
  $(play).attr("src", 'play.png');
}

// Add the main panel
var vis = new pv.Panel()
    .width(w)
    .height(h)
    .top(5)
    .bottom(20);

// Add the ticks and labels for the year slider
vis.add(pv.Rule)
    .data(pv.range(birthreg.minYear, birthreg.maxYear + .1))
    .left(yearsScale)
    .height(4)
    .bottom(-15)
  .anchor("top").add(pv.Label)
     .textMargin("1em")
     .textAlign("left")
     .textBaseline("middle")
     .textAngle(-Math.PI/3);

// Add a panel for each state
var state = vis.add(pv.Panel)
    .data(us_lowres);

// Add a panel for each state land mass, where color depends on the state's status.
// TODO: implement this as overlapping area colors, a la
//   http://vis.stanford.edu/protovis/docs/inheritance.html
state.add(pv.Panel)
    .data(function(c) c.borders)
    .add(pv.Line)
      .data(function(l) l)
    .left(scale.x)
    .top(scale.y)
    .fillStyle(function(d, l, c) col(year, birthreg[c.code])  )
    .lineWidth(1)
    .strokeStyle("white")
    .antialias(false);

// Add a label with the state code in the middle of every state
vis.add(pv.Label)
    .data(us_lowres)
    .left(function(c) scale(c.centLatLon).x)
    .top(function(c) scale(c.centLatLon).y)
    .text(function(c) c.code)
    .textAlign("center")
    .textBaseline("middle");

/* Legend. */
vis.add(pv.Bar)
    .data(labels)
    .top(function() 380 + this.index *22)
    .left(60)
    .height(20)
    .width(20)
    .strokeStyle(null)
    .fillStyle(colors)
  .anchor("right").add(pv.Label).textAlign("left");


vis.render();

    </script>
        <div id="container">
      <b id="yearLabel">Year:</b
      ><div id="yearSlider"></div
      ><img id="play" src="play.png" alt="Play" onclick="playClick()">
    </div>

  </div>
</div>
<div>
(The "death registration area" and "birth registration area" were/are the jurisdictions which meet the federal standard of registering at least 90% of each year's deaths (or births). This is a little tool I'm using to work through some policy diffusion questions for my <a href="http://cliotropic.org/blog/about/#research">dissertation</a>. It was built with <a href+"http://vis.stanford.edu/protovis/">Protovis</a>.)
</div></body>
</html>
